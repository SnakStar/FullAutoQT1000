#include "testinterface.h"
#include "ui_testinterface.h"
#include "mainwindow.h"

TestInterface::TestInterface(QWidget *parent) :
    QDialog(parent),
    ui(new Ui::TestInterface)
{
    ui->setupUi(this);
    MainWindow* MainWnd = (MainWindow*)parent;
    //
    m_pMainWnd = parent;
    //初始化未完成测试总数
    m_nCompleteTestCount = 0;
    //新建测试不可用
    ui->pb_Test_NewTest->setEnabled(false);
    ui->pb_Test_DetailsInfo->setEnabled(false);
    //获取配置文件对象
    m_settins = MainWnd->GetSettingsObj();
    //获取数据库对象
    m_Devdb = MainWnd->GetDatabaseObj();
    //初始化圆界面
    InitCircle();
    //进度条控件,显示试剂卡剩余数量
    InitProgressBar();
    //列表框
    InitTableInfo();
    //初始化测试信息
    InitVectorTestInfo();
    //隐藏测试项目
    ShowTestItem(false);
    //初始化当前可测试项目和试剂数量
    InitValidTestItem();
    //初始化检测板串口
    InitCheckPanelsSerial();
    connect(&m_CheckPanelsSerial,SIGNAL(readyRead()), this, SLOT(RecvCheckPanelsData()) );
    //初始化控制板串口
    InitControlPanelsSerial();
    connect(&m_ControlPanelsSerial,SIGNAL(readyRead()), this, SLOT(RecvControlPanelsData()) );

    //查询测试板初始化情况
    connect(&m_TimerTestCheck, SIGNAL(timeout()), this, SLOT(TestCheckFunc()) );
    m_TimerTestCheck.start(1000);


    m_mapTestItemPos.insert("hsCRP","1");
    m_mapTestItemPos.insert("PCT",  "2");
    m_mapTestItemPos.insert("CRP",  "3");
    m_mapTestItemPos.insert("cTnI", "4");

    /*char c[]  = {0x33,0x30,0x35,0x11,0x11,0x11,0x11,0x02,0x01,0x02,0x00,0x00,0x01,0x02,0x00,0x00, 0x01,0x02,0x00,0x00};
    QByteArray s = c;
    //qDebug()<<(unsigned char)s[0];
    ScanBarCodeInfo bar;
    memcpy_s(&bar,sizeof(bar),s,sizeof(bar));
    QString ss;
    for(int n=0;n<16;n++){
        ss += bar.scaninfo[0].CODE[n];
    }
    qDebug()<<ss.size();
    qDebug()<<bar.scaninfo[0].Scan_State;*/

}

TestInterface::~TestInterface()
{
    delete ui;
}

/*
 *
 *初始化检测板串口
 */
/////////////////////////////////////////////////////////
bool TestInterface::InitCheckPanelsSerial()
{
    //串口初始化
    m_CheckPanelsSerial.setBaudRate(BAUD19200);
#ifdef Q_OS_WIN32
    m_CheckPanelsSerial.setPortName("\\\\.\\com9");
#else
    m_CheckPanelsSerial.setPortName("/dev/ttyO1");
#endif
    bool bOpen = m_CheckPanelsSerial.open(QIODevice::ReadWrite);
    if(!bOpen){
        qDebug()<<"CheckPanels Serial open the fail";
    }
    return bOpen;
}

/********************************************************
 *@Name:        ParseSerialData
 *@Author:      HuaT
 *@Description: 解析串口发来的一帧数据，检测是否为完整的一帧数据
 *@Param1:      串口数据
 *@Return:      如果为完整一帧数据则返回真，否则返回false
 *@Version:     1.0
 *@Date:        2018-5-21
********************************************************/
bool TestInterface::ParseSerialData(const QByteArray &Data)
{
    MsgData CurrData;
    //qDebug()<<"CurrData.m_frameHeader:"<<CurrData.m_frameHeader;
    //qDebug()<<"Data.mid(0,4).toHex().toUInt(0,16):"<<Data.mid(0,4).toHex().toUInt(0,16);
    //qDebug()<<"CurrData.m_frameEnd:"<<CurrData.m_frameEnd;
    //qDebug()<<"Data.right(4).toHex().toUInt(0,16):"<<Data.right(4).toHex().toUInt(0,16);
    if(CurrData.m_frameHeader == BytesToInt( Data.mid(0,4) )
            && CurrData.m_frameEnd == BytesToInt( Data.right(4) ) ){
        return true;
    }else{
        return false;
    }
}

/********************************************************
 *@Name:        FillValidSerialData
 *@Author:      HuaT
 *@Description: 装填有效的数据到MsgData结构体
 *@Param1:      完整的一帧串口数据
 *@Param2:      需要填充的消息结构体
 *@Return:      返回是否填充成功
 *@Version:     1.0
 *@Date:        2018-5-21
********************************************************/
bool TestInterface::FillValidSerialData(QByteArray SerailData, MsgData& CurrData)
{
    int nDataCount = SerailData.size();
    quint8 nContentLen = BytesToInt(SerailData.mid(12,4));
    CurrData.m_CRC = BytesToInt(SerailData.mid(nDataCount-8,4));
    //qDebug()<<"nContentLen"<<nContentLen;
    quint32 nCRC = GetCheckSum(SerailData.mid(12,4),SerailData.mid(16,nContentLen*4));
    //qDebug()<<"my check code:"<<nCRC<<" currdata.m_crc:"<<CurrData.m_CRC;
    if(nCRC == CurrData.m_CRC ){
        CurrData.m_ProductID = BytesToInt( SerailData.mid(4,4) );
        CurrData.m_DeviceAdd = BytesToInt( SerailData.mid(8,2) );
        CurrData.m_FuncIndex = BytesToInt( SerailData.mid(10,2) );
        CurrData.m_DataLength = BytesToInt( SerailData.mid(12,4) );
        CurrData.m_Data = SerailData.mid(16,CurrData.m_DataLength*4) ;
        return true;
    }else{
        return false;
    }
}

/********************************************************
 *@Name:        ParseTestResultData
 *@Author:      HuaT
 *@Description: 解析测试结果数据
 *@Param1:      接收到的结果数据
 *@Return:      解析是否成功
 *@Version:     1.0
 *@Date:        2018-6-16
********************************************************/
bool TestInterface::ParseTestResultData(const QByteArray &AckData)
{
    if(AckData.size() != 648){
        QMessageBox::information(this,QObject::tr("Note"),
                                 QObject::tr("结果数据长度不符,长度为：%1").arg(AckData.size()),
                                 QMessageBox::Ok);
        return false;
    }
    quint32 nSamplePos = BytesToInt(AckData.mid(0,4));
    quint32 nReagentPos = BytesToInt(AckData.mid(4,4));
    QByteArray byarrResultData = AckData.mid(8,AckData.size()-8);
    //解析测试结果命令
    //m_vecTestInfo.at(1).m_si.m_SamPos.m_nSamplePos
    qDebug()<<"parse result:"<<nSamplePos<<m_vecTestInfo.at(nSamplePos).m_si.m_SamPos.m_nSamplePos<<m_vecTestInfo.at(nSamplePos).m_si.m_strSampleNo;
    //保存数据到数据库
    SaveResultToDB(m_vecTestInfo.at(nSamplePos));
    //UI显示完成
    m_SampleCircle->SetItemColor(nReagentPos,"rgb(0,255,0)");
    m_SampleCircle->SetItemText(nReagentPos,QObject::tr("完成"));
    //判断是否完成所有测试
    m_nCompleteTestCount++;
    quint8 nTestCount = ui->lb_Test_SampleCount->text().toInt();
    //测试基本信息修改
    UpdateTestInfoBaseParam(m_nCompleteTestCount);
    if(m_nCompleteTestCount == nTestCount){
        //开始卸卡程序
        StartUnstallCard();
        //
    }
}


/********************************************************
 *@Name:        SaveResultToDB
 *@Author:      HuaT
 *@Description: 保存结果至数据库
 *@Param1:      测试信息结构体
 *@Return:      保存数据是否成功
 *@Version:     1.0
 *@Date:        2018-6-16
********************************************************/
bool TestInterface::SaveResultToDB(TestInfo ti)
{
    QString strCurDate = QDateTime::currentDateTime().toString("yyyy-MM-dd hh:mm:ss");
    QString strSQL = QString("insert into patient values(null,%1,'',0,0,'%2','%3','%4','','')").arg(ti.m_si.m_strSampleNo.toLongLong()).arg(ti.m_strItemName).arg("1.1ng/l").arg(strCurDate);
    //qDebug()<<strSQL;
    return m_Devdb->Exec(strSQL);
    //return true;
}

void TestInterface::UpdateTestInfoBaseParam(quint8 nCompeletCount)
{
    //测试基本信息修改
    int nTestCount = ui->lb_Test_SampleCount->text().toInt();
    if(nTestCount == 0){
        ui->lb_Test_WaitTestNumValue->setText("0");
        ui->lb_Test_CompTestNumValue->setText("0");
    }else{
        ui->lb_Test_WaitTestNumValue->setText(QString::number(nTestCount - nCompeletCount));
        ui->lb_Test_CompTestNumValue->setText(QString::number(nCompeletCount));
    }
}

/********************************************************
 *@Name:        StartUnstallCard
 *@Author:      HuaT
 *@Description: 开始根据试剂数量发送卸卡命令
 *@Param1:      无
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-5-21
********************************************************/
void TestInterface::StartUnstallCard()
{
    QVector<TestInfo>::Iterator iter;
    for(iter = m_vecTestInfo.begin(); iter != m_vecTestInfo.end(); iter++){
        //qDebug()<<"((TestInfo*)(iter))->m_si.m_SamPos.m_nReagentPos"<<((TestInfo*)(iter))->m_si.m_SamPos.m_nReagentPos;
        if( ((TestInfo*)(iter))->m_si.m_SamPos.m_nReagentPos != -1){
            //发送准备卸卡命令
            QByteArray byarrReagentPos = IntToBytes((*iter).m_si.m_SamPos.m_nReagentPos);
            SendSerialData(m_ControlPanelsSerial,PL_FUN_AM_PREPARE_UNSTALL,byarrReagentPos);
            (*iter).m_si.m_SamPos.m_nReagentPos = -1;
            return;
        }
    }
    //所有卡卸载完成后，清空数据，恢复新建状态
    AllTestComplete();
}

/********************************************************
 *@Name:        AllTestComplete
 *@Author:      HuaT
 *@Description: 所有测试完成后，清空结构体，恢复界面新建
 *@Param1:      无
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-5-21
********************************************************/
void TestInterface::AllTestComplete()
{
    //清空结构体
    m_vecTestInfo.clear();
    InitVectorTestInfo();
    //恢复界面
    //新建测试和开始测试可用
    ui->pb_Test_NewTest->setEnabled(true);
    ui->pb_Test_StartTest->setEnabled(true);
    //详细信息界面按钮可用
    SetRuntimeButtonEnable(true);
    //初始化列表信息
    InitTableInfo();
    //初始化圆的颜色
    DefaultCircleUI();
    //样本总数置0
    ui->lb_Test_SampleCount->setText("0");
    //基本信息初始化
    ui->lb_Test_WaitTestNumValue->setText("0");
    ui->lb_Test_CompTestNumValue->setText("0");
    //测试项目名称清空
    ui->lb_Test_TestProject->setText("");
}

/********************************************************
 *@Name:        RecvCheckPanelsData
 *@Author:      HuaT
 *@Description: 接收仪器检测板串口数据
 *@Param1:      无
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-5-21
********************************************************/
void TestInterface::RecvCheckPanelsData()
{
    //qDebug()<<m_DeviceSerial.readAll().toHex();
    QByteArray byarrData = m_CheckPanelsSerial.readAll();
    //qDebug()<<byarrData.right(4).toHex().toUInt(0,16);
    m_byarrCheckData.append(byarrData);
    //检测是否为完整一帧数据
    //qDebug()<<m_byarrCheckData.toHex().toUpper();
    if(!ParseSerialData(m_byarrCheckData)){
        return;
    }
    //qDebug()<<"RecvCheckPanelsData:"<<m_byarrCheckData.toHex().toUpper();
    //填充数据
    MsgData CurrData;
    if(FillValidSerialData(m_byarrCheckData,CurrData)){
        qDebug()<<"RecvCheckPanelsData:"<<CurrData.m_FuncIndex;
        //MsgData msgd;
        switch(CurrData.m_FuncIndex){
        case PL_FUN_ACK:
            //返回ACK
            ParseCheckPanelsAck(CurrData.m_Data);
            break;
        case PL_FUN_ALARM:
            //仪器报警
            break;
            /*case PL_FUN_AM_HARDWEAR_CHECK:
                    qDebug()<<"PL_FUN_AM_HARDWEAR_CHECK";
                    msgd.Clear();
                    msgd.m_FuncIndex = PL_FUN_AM_HARDWEAR_CHECK;
                    msgd.m_DataLength = 4;
                    break;*/
        case PL_FUN_AM_TEST_RESULT :
            //收到测试结果
            qDebug()<<"PL_FUN_AM_TEST_RESULT ";
            ParseTestResultData(CurrData.m_Data);
            break;
        case PL_FUN_AM_START_UNSTALL_COMPLETE:{
            if(m_bIsCheckStatus){//如果是自检状态
                //解析卸卡的数据
                ParseUnstallCardData();
                quint32 nCardNum = BytesToInt(CurrData.m_Data);
                m_SampleCircle->SetItemColor(nCardNum,"rgb(128,128,128)");
                m_SampleCircle->SetItemText(nCardNum,QString::number(nCardNum));
            }else{//如果是测试状态
                //卸卡完成,开始卸载下一张卡
                StartUnstallCard();
            }
            break;
        }
        default:
            qDebug()<<"command is invalid!";
        }
    }
    m_byarrCheckData.clear();
}

/*
 *
 *初始化控制板串口
 */
bool TestInterface::InitControlPanelsSerial()
{
    //串口初始化
    m_ControlPanelsSerial.setBaudRate(BAUD19200);
#ifdef Q_OS_WIN32
    m_ControlPanelsSerial.setPortName("\\\\.\\com8");
#else
    m_ControlPanelsSerial.setPortName("/dev/ttyO4");
#endif
    bool bOpen = m_ControlPanelsSerial.open(QIODevice::ReadWrite);
    if(!bOpen){
        qDebug()<<"ControlPanels Serial open the fail";
    }
    return bOpen;
}

void TestInterface::RecvControlPanelsData()
{
    //qDebug()<<m_DeviceSerial.readAll().toHex();
    QByteArray byarrData = m_ControlPanelsSerial.readAll();
    //qDebug()<<byarrData.right(4).toHex().toUInt(0,16);
    m_byarrControlData.append(byarrData);
    //检测是否为完整一帧数据
    //qDebug()<<"RecvControlPanelsData:"<<m_byarrControlData.toHex().toUpper();
    if(!ParseSerialData(m_byarrControlData)){
        return;
    }
    qDebug()<<"RecvControlPanelsData:"<<m_byarrControlData.toHex().toUpper();
    //填充数据
    MsgData CurrData;
    if(FillValidSerialData(m_byarrControlData,CurrData)){
        //qDebug()<<"RecvControlPanelsData:"<<CurrData.m_FuncIndex;
        //MsgData msgd;
        switch(CurrData.m_FuncIndex){
        case PL_FUN_ACK:
            //返回ACK
            ParseControlPanelsAck(CurrData.m_Data);
            break;
        case PL_FUN_ALARM:
            //仪器报警
            ParseControlPanelsAlarmData(CurrData.m_Data);
            break;
            /*case PL_FUN_AM_HARDWEAR_CHECK:
                qDebug()<<"PL_FUN_AM_HARDWEAR_CHECK";
                msgd.Clear();
                msgd.m_FuncIndex = PL_FUN_AM_HARDWEAR_CHECK;
                msgd.m_DataLength = 4;
                break;*/
        case PL_FUN_AM_SCAN_RESULT:
            //收到扫码结果
            ParseScanBarCodeInfo(CurrData.m_Data);
            ShowBarCodeInfo(m_vecTestInfo);
            break;
        case PL_FUN_AM_SAMPLE_COMPLETE:
            //收到加样完成，进行倒计时
            ProceStartLoadSample(CurrData.m_Data);
            break;
        case PL_FUN_AM_PREPARE_TEST_COMPLETE:
        {
            //收到准备测试完成，发送开始测试
            PorceLoadSampleComplete(CurrData.m_Data);
            break;
        }
        case PL_FUN_AM_PREPARE_UNSTALL_COMPLETE:
        {
            //卸卡准备完成，开始卸卡
            QByteArray byarrUnstallData = IntToBytes(0);
            SendSerialData(m_CheckPanelsSerial,PL_FUN_AM_START_UNSTALL,byarrUnstallData);
            break;
        }
        case PL_FUN_AM_ID_CARD_DATA:
            //收到ID卡数据
            m_mapTestItemPos.insert("hsCRP","1");
            m_mapTestItemPos.insert("CRP","2");
            m_mapTestItemPos.insert("PCT","3");
            m_mapTestItemPos.insert("cTni","4");
            break;
        default:
            qDebug()<<"command is invalid!";
        }
    }
    m_byarrControlData.clear();

}

/********************************************************
 *@Name:        ParseControlPanelsAlarmData
 *@Author:      HuaT
 *@Description: 解析
 *@Param1:      无
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-5-21
********************************************************/
void TestInterface::ParseControlPanelsAlarmData(const QByteArray &AlarmData)
{
    if(AlarmData.size() != 8){
        qDebug()<<"Alarm Data size does not match:"<<AlarmData.size();
        return;
    }
    quint32 nAlarmType = BytesToInt( AlarmData.mid(0,4));
    quint32 nAlarmData = BytesToInt( AlarmData.mid(4,4));
    QByteArray byarrAlarmType = QString("%1").arg(nAlarmType,32,2,QLatin1Char('0')).toAscii();
    if(byarrAlarmType.at(31) == 49){
        //ID卡被移除
        //提醒用户
        qDebug()<<"ID卡被移除消息";
        //改变界面ID卡状态
    }else if(byarrAlarmType.at(30) == 49){
        //ID卡错误
        qDebug()<<"ID卡错误消息";
        //提醒用户更换ID卡槽
    }else if(byarrAlarmType.at(29) == 49){
        //仪器运行时错误
        qDebug()<<"仪器运行时错误消息";
    }else if(byarrAlarmType.at(28) == 49){
        //复位错误
        qDebug()<<"仪器复位错误消息";
    }else if(byarrAlarmType.at(27) == 49){
        //缓冲液为空
        qDebug()<<"缓冲液为空消息";
    }else if(byarrAlarmType.at(26) == 49){
        //样本为空
        QString strContent = QObject::tr("样本%1未吸到样本，测试失败，请稍后重试!").arg(nAlarmData+1);
        QMessageBox::information(this,QObject::tr("Note"),strContent,QMessageBox::Ok);
    }

}


/********************************************************
 *@Name:        CountDown
 *@Author:      HuaT
 *@Description: 倒计时函数
 *@Param1:      无
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-5-21
********************************************************/
void TestInterface::CountDown()
{
    //quint32 nTime = sender()->property("time").toInt();
    quint32 nReagentPos = sender()->property("ReagentPos").toInt();
    quint32 nSamplePos = sender()->property("SamplePos").toInt();
    //qDebug()<<nTime;
    //处理倒计时事件
    ProceCountDownEvent(nReagentPos,nSamplePos);
}

/********************************************************
 *@Name:        TestCheckFunc
 *@Author:      HuaT
 *@Description: 计时器测试板自检函数
 *@Param1:      无
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-5-21
********************************************************/
void TestInterface::TestCheckFunc()
{
    SendSerialData(m_CheckPanelsSerial,PL_FUN_AM_HARDWEAR_CHECK);
}

/********************************************************
 *@Name:        ControlCheckFunc
 *@Author:      HuaT
 *@Description: 计时器控制板自检函数
 *@Param1:      无
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-5-21
********************************************************/
void TestInterface::ControlCheckFunc()
{
    SendSerialData(m_ControlPanelsSerial,PL_FUN_AM_HARDWEAR_CHECK);
}

/*
 *新建测试响应事件
 */
void TestInterface::on_pb_Test_NewTest_clicked()
{
    ui->stackedWidget->setCurrentIndex(1);
    m_TestCircle->HideAllCircle(true);
    m_SampleCircle->HideAllCircle(true);
    //判断是否为扫码设置
    bool isScan = true;
    if(isScan){
        //发送扫码信息
        SendSerialData(m_ControlPanelsSerial,PL_FUN_AM_NEW_TEST);
    }else{
        //自动编码
    }
}

/*
 *详细信息响应事件
 */
void TestInterface::on_pb_Test_DetailsInfo_clicked()
{
    ui->stackedWidget->setCurrentIndex(1);
    m_TestCircle->HideAllCircle(true);
    m_SampleCircle->HideAllCircle(true);
}

/*
 *详细页返回按钮响应事件
 */
void TestInterface::on_pb_Test_Back_clicked()
{
    ui->stackedWidget->setCurrentIndex(0);
    m_TestCircle->HideAllCircle(false);
    m_SampleCircle->HideAllCircle(false);
}

/*
 *详细页开始按钮响应事件
 */
void TestInterface::on_pb_Test_StartTest_clicked()
{
    //检测用户输入
    bool isValid = CheckUserInputValid();
    if(!isValid){
        QMessageBox::information(this,QObject::tr("Note"),QObject::tr("至少选择一项测试"),QMessageBox::Ok);
        return;
    }
    //已完成测试总数初始化
    m_nCompleteTestCount = 0;
    //跳回状态页
    ui->stackedWidget->setCurrentIndex(0);
    //显示圆
    m_TestCircle->HideAllCircle(false);
    m_SampleCircle->HideAllCircle(false);
    //新建测试和开始测试不可用
    ui->pb_Test_NewTest->setEnabled(false);
    ui->pb_Test_StartTest->setEnabled(false);
    //详细信息界面按钮不可用
    SetRuntimeButtonEnable(false);
    //发送所有测试信息给仪器
    quint8  nEmerIndex = ui->lb_Test_CurrentEmerPos->text().toInt();
    if(nEmerIndex != 0){
        TestInfo ti = m_vecTestInfo.at(nEmerIndex-1);
        m_vecTestInfo.remove(nEmerIndex-1);
        m_vecTestInfo.insert(0,ti);
    }
    //打包测试信息数据
    QByteArray byarrTestNumbleData;
    byarrTestNumbleData = PacketTestInfoToByarr(m_vecTestInfo);
    if(byarrTestNumbleData.isEmpty()){
        return;
    }
    SendSerialData(m_ControlPanelsSerial,PL_FUN_AM_START_SAMPLE,byarrTestNumbleData);
    //测试基本信息修改
    UpdateTestInfoBaseParam(m_nCompleteTestCount);
    /*for(int n=0; n<16;n++){
        qDebug()<<m_vecTestInfo.at(n).m_nSamplePos<<":"<<m_vecTestInfo.at(n).m_bIsEmerg<<"-"<<m_vecTestInfo.at(n).m_strSampleNo<<"-"<<m_vecTestInfo.at(n).m_strItemName<<";";

    }*/
}

/********************************************************
 *@Name:        SendTestInfoToDevice
 *@Author:      HuaT
 *@Description: 发送开始测试信息命令给仪器
 *@Param1:      所有测试信息数组
 *@Return:      是否是送成功
 *@Version:     1.0
 *@Date:        2018-5-21
********************************************************/
QByteArray TestInterface::PacketTestInfoToByarr(QVector<TestInfo> &vecTestInfo)
{
    QByteArray byarrTestInfo;
    QString strTestItem;
    QVector<TestInfo>::iterator iter;
    for(iter = vecTestInfo.begin(); iter != vecTestInfo.end(); iter++){
        if((*iter).m_bIsTest){
            //是否测试标记（现在发过去的项目都测试，所以这个标记已弃用）
            byarrTestInfo.append(IntToBytes(0));
            //样本位置
            byarrTestInfo.append( IntToBytes((*iter).m_si.m_SamPos.m_nSamplePos) );
            //改变颜色,由于样本盘编号由0到15,圆的设定由1开始,所以加1
            m_TestCircle->SetItemColor( (*iter).m_si.m_SamPos.m_nSamplePos+1,"rgb(0,255,0)");
            //
            strTestItem = (*iter).m_strItemName;
            //ID卡位置编号
            if(!m_mapTestItemPos.contains(strTestItem)){
                QString strMsg = QObject::tr("没有对应项目%1的试剂卡,请先插卡").arg(strTestItem);
                QMessageBox::information(this,QObject::tr("Note"),strMsg,QMessageBox::Ok);
                return QByteArray("");
            }else{
                switch(m_mapTestItemPos.value(strTestItem).toInt()){
                case 1:
                    byarrTestInfo.append(IntToBytes(1));
                    break;
                case 2:
                    byarrTestInfo.append(IntToBytes(256));
                    break;
                case 3:
                    byarrTestInfo.append(IntToBytes(65536));
                    break;
                case 4:
                    byarrTestInfo.append(IntToBytes(65536*256));
                    break;
                }
            }
            //缓冲液位置编号
            byarrTestInfo.append(IntToBytes(1));
            //本项目已经测试
            (*iter).m_bIsTest = false;
            return byarrTestInfo;
        }
    }
    return byarrTestInfo;
}

/********************************************************
 *@Name:        CheckUserInputValid
 *@Author:      HuaT
 *@Description: 检测用户输入项目类型是否有效
 *@Param1:      无
 *@Return:      是否为有效输入
 *@Version:     1.0
 *@Date:        2018-5-22
********************************************************/
bool TestInterface::CheckUserInputValid()
{
    int nCount = 0;
    QString strSampleNo;
    QString strItemName;
    for(int n=0; n<TABLE_ROWS_COUNT; n++){
        strItemName.clear();
        strSampleNo = ui->tw_Test_TestInfo->item(n,TABLE_COLUMN_COUNT-2)->text();
        strItemName = ui->tw_Test_TestInfo->item(n,TABLE_COLUMN_COUNT-1)->text();
        if(!strSampleNo.isEmpty() && !strItemName.isEmpty()){
            m_vecTestInfo[n].m_si.m_strSampleNo = strSampleNo;
            m_vecTestInfo[n].m_strItemName = strItemName;
            //是否需要测试
            m_vecTestInfo[n].m_bIsTest     = true;
            nCount++;
        }
        //qDebug()<<m_vecTestInfo.at(n).m_nSamplePos<<":"<<m_vecTestInfo.at(n).m_bIsEmerg<<"-"<<m_vecTestInfo.at(n).m_strSampleNo<<"-"<<m_vecTestInfo.at(n).m_strItemName<<";";
    }
    ui->lb_Test_SampleCount->setText(QString("%1").arg(nCount));
    if(nCount == 0){
        return false;
    }else{
        return true;
    }
}

/*
 *初始化测试圆和样品圆界面
 */
void TestInterface::InitCircle()
{
    //测试盘
    m_TestCircle = new CircleLayout(this);
    QPoint posTest(210,200);
    m_TestCircle->CreateCircleLayout(180,posTest, TABLE_ROWS_COUNT);

    //样品盘
    m_SampleCircle = new CircleLayout(this);
    QPoint posSam(730,200);
    m_SampleCircle->CreateCircleLayout(180,posSam,20);

}

/********************************************************
 *@Name:        DefaultCircleUI
 *@Author:      HuaT
 *@Description: 默认测试界面圆颜色
 *@Param1:      无
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-5-21
********************************************************/
void TestInterface::DefaultCircleUI()
{
    DefaultSampleCircleUI();
    DefaultTestCircleUI();
}

void TestInterface::DefaultSampleCircleUI()
{
    for(int i=1; i<21;i++){
        m_SampleCircle->SetItemText(i,QString::number(i));
        m_SampleCircle->SetItemColor(i,"rgb(128,128,128)");
    }
}

void TestInterface::DefaultTestCircleUI()
{
    for(int n=1; n<17; n++){
        m_TestCircle->SetItemText(n,QString::number(n));
        m_TestCircle->SetItemColor(n,"rgb(128,128,128)");
    }
}

/********************************************************
 *@Name:        InitProgressBar
 *@Author:      HuaT
 *@Description: 初始化进度条参数
 *@Param1:      无
 *@Param2:      无
 *@Param3:      无
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-5-21
********************************************************/
void TestInterface::InitProgressBar()
{
    ui->proBar_Test_Reagent1->setStyleSheet("QProgressBar{background-color: #E6E6E6;border: 1px solid grey;border-radius: 1px;}");
    ui->proBar_Test_Reagent2->setStyleSheet("QProgressBar{background-color: #E6E6E6;border: 1px solid grey;border-radius: 1px;}");
    ui->proBar_Test_Reagent3->setStyleSheet("QProgressBar{background-color: #E6E6E6;border: 1px solid grey;border-radius: 1px;}");
    ui->proBar_Test_Reagent4->setStyleSheet("QProgressBar{background-color: #E6E6E6;border: 1px solid grey;border-radius: 1px;}");

}

/********************************************************
 *@Name:        InitTableInfo
 *@Author:      HuaT
 *@Description: 初始化列表信息控件
 *@Param1:      无
 *@Param2:      无
 *@Param3:      无
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-5-21
********************************************************/
void TestInterface::InitTableInfo()
{
    //
    QStringList header;
    //header<<QObject::tr("急诊")<<QObject::tr("样本位")<<QObject::tr("样本编号")<<QObject::tr("测试项目");
    header<<QObject::tr("样本位")<<QObject::tr("样本编号")<<QObject::tr("测试项目");
    //
    ui->tw_Test_TestInfo->setColumnCount(TABLE_COLUMN_COUNT);
    ui->tw_Test_TestInfo->setRowCount(TABLE_ROWS_COUNT);
    //
    ui->tw_Test_TestInfo->setHorizontalHeaderLabels(header);
    ui->tw_Test_TestInfo->verticalHeader()->setHidden(true);

    //ui->tw_Test_TestInfo->verticalHeader()->setHidden(true);
    ui->tw_Test_TestInfo->setEditTriggers(QTableWidget::NoEditTriggers);
    ui->tw_Test_TestInfo->setSelectionBehavior(QTableWidget::SelectRows);
    //
    //ui->tw_Test_TestInfo->setColumnWidth(0,40);
    ui->tw_Test_TestInfo->setColumnWidth(0,80);
    ui->tw_Test_TestInfo->setColumnWidth(1,230);
    ui->tw_Test_TestInfo->setColumnWidth(2,220);
    ui->tw_Test_TestInfo->horizontalHeader()->setStretchLastSection(true);
    //
    ui->tw_Test_TestInfo->verticalHeader()->setDefaultSectionSize(37);
    //
    for(int i=0; i< TABLE_ROWS_COUNT; i++){
        //ui->tw_Test_TestInfo->setRowHeight(i,37);
        QRadioButton* radio = new QRadioButton();
        radio->setStyleSheet("margin-left:12px");

        QTableWidgetItem* item1 = new QTableWidgetItem();
        item1->setText(QString("%1").arg(i+1));
        item1->setTextAlignment(Qt::AlignCenter);

        QTableWidgetItem* item2 = new QTableWidgetItem();
        //item2->setText(QString("Number:%11111111").arg(i));
        item2->setText("");
        item2->setTextAlignment(Qt::AlignCenter);

        QTableWidgetItem* item3 = new QTableWidgetItem();
        //item3->setText(QString("POS:%1").arg(i));
        item3->setText("");
        item3->setTextAlignment(Qt::AlignCenter);

        //ui->tw_Test_TestInfo->setCellWidget(i,0,radio);
        ui->tw_Test_TestInfo->setItem(i,0,item1);
        ui->tw_Test_TestInfo->setItem(i,1,item2);
        ui->tw_Test_TestInfo->setItem(i,2,item3);
    }
    //ui->tw_Test_TestInfo->itemAt()
    //ui->tw_Test_TestInfo->setAlternatingRowColors(true);

}

/********************************************************
 *@Name:        ShowTestItem
 *@Author:      HuaT
 *@Description: 显示或者隐藏测试项目按钮
 *@Param1:      是否显示
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-5-21
********************************************************/
void TestInterface::ShowTestItem(bool isShow)
{
    if(isShow){
        ui->pb_Test_TestName1->show();
        ui->pb_Test_TestName2->show();
        ui->pb_Test_TestName3->show();
        ui->pb_Test_TestName4->show();
    }else{
        ui->pb_Test_TestName1->hide();
        ui->pb_Test_TestName2->hide();
        ui->pb_Test_TestName3->hide();
        ui->pb_Test_TestName4->hide();
    }
}

/********************************************************
 *@Name:        InitValidTestItem
 *@Author:      HuaT
 *@Description: 初始化当前可测试的项目类型
 *@Param1:      无
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-5-21
********************************************************/
void TestInterface::InitValidTestItem()
{
    QString strReagent1 = m_settins->ReadSettings(REAGENT1,"").toString();
    QString strReagent2 = m_settins->ReadSettings(REAGENT2,"").toString();
    QString strReagent3 = m_settins->ReadSettings(REAGENT3,"").toString();
    QString strReagent4 = m_settins->ReadSettings(REAGENT4,"").toString();
    if(!strReagent1.isEmpty()){
        ui->pb_Test_TestName1->setText(strReagent1);
        ui->pb_Test_TestName1->show();
    }
    if(!strReagent2.isEmpty()){
        ui->pb_Test_TestName2->setText(strReagent2);
        ui->pb_Test_TestName2->show();
    }
    if(!strReagent3.isEmpty()){
        ui->pb_Test_TestName3->setText(strReagent3);
        ui->pb_Test_TestName3->show();
    }
    if(!strReagent4.isEmpty()){
        ui->pb_Test_TestName4->setText(strReagent4);
        ui->pb_Test_TestName4->show();
    }
    if(strReagent1.isEmpty()&&strReagent2.isEmpty()&&strReagent3.isEmpty()&&strReagent4.isEmpty()){
        ui->lb_Test_TestItemStatus->show();
    }else{
        ui->lb_Test_TestItemStatus->hide();
    }
}

/********************************************************
 *@Name:        ClearTableInfo
 *@Author:      HuaT
 *@Description: 清除列表控件中的内容
 *@Param1:      无
 *@Param2:      无
 *@Param3:      无
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-5-21
********************************************************/
void TestInterface::ClearTableInfo()
{
    ui->tw_Test_TestInfo->setRowCount(0);
    ui->tw_Test_TestInfo->setColumnCount(0);
    InitTableInfo();
}

/*
 *详细页样本全选勾选框响应事件
 */
void TestInterface::on_checkBox_Test_AllSelect_clicked()
{

}

/********************************************************
 *@Name:        ClearCellContent
 *@Author:      HuaT
 *@Description: 清除指定单元格内容
 *@Param1:      单元格所在列
 *@Param2:      单元格所在行
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-5-21
********************************************************/
void TestInterface::ClearCellContent(int Column, int Row)
{
    QTableWidgetItem* item = ui->tw_Test_TestInfo->item(Row,Column);
    item->setText("");
}

/********************************************************
 *@Name:        SetCellContent
 *@Author:      HuaT
 *@Description: 清除指定单元格内容
 *@Param1:      单元格所在列
 *@Param2:      单元格所在行
 *@Param3:      单元格内容
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-5-21
********************************************************/
void TestInterface::SetCellContent(int Column, int Row, QString strContent)
{
    QTableWidgetItem* item = ui->tw_Test_TestInfo->item(Row,Column);
    item->setText(strContent);
}


/*
 *详细页清除按钮响应事件
 */
void TestInterface::on_pb_Test_ClearTestName_clicked()
{
    if(ui->checkBox_Test_AllSelect->isChecked() == true){
        if(QMessageBox::Yes == QMessageBox::information(this,"提示","删除所有？",QMessageBox::Yes|QMessageBox::No)){
            for(int i=0; i< TABLE_ROWS_COUNT; i++){
                ClearCellContent(TABLE_COLUMN_COUNT-1, i);
            }
        }
    }else{
        int nCurRow = ui->tw_Test_TestInfo->currentRow();
        if(nCurRow == -1){
            return ;
        }
        ClearCellContent(TABLE_COLUMN_COUNT-1,nCurRow);
    }
    ui->lb_Test_TestProject->setText("");
}


/*
 *详细页自动扫码按钮响应事件
 */
void TestInterface::on_pb_Test_ScanModel_clicked()
{
    QString strScanModel = ui->pb_Test_ScanModel->text();
    if(strScanModel == QObject::tr("自动扫码")){
        //qDebug()<<"auto scan";
        SendSerialData(m_ControlPanelsSerial,PL_FUN_AM_NEW_TEST);
    }else{
        //qDebug()<<"manual scan";
    }
    //int nte = 12345;
    //qDebug()<<QString("%1").arg(nte,32,2,QLatin1Char('0')).toAscii();

}

/********************************************************
 *@Name:        TransformProjectName
 *@Author:      HuaT
 *@Description: 项目名称转化,hsCPR在hsCRP/PCT经过转化后为PCT
 *@Param1:      目标名称
 *@Param2:      现有的名称集,hsCRP/PCT/cTnI格式
 *@Return:      返回处理过后的字符串
 *@Version:     1.0
 *@Date:        2018-5-22
********************************************************/
QString TestInterface::TransformProjectName(QString strCurName, QString strNameRecord)
{
    QString strResult = "";

    if(strNameRecord.isEmpty()){
        strResult = strCurName;
    }else{
        QStringList listName = strNameRecord.split("/");
        int nIndex = listName.indexOf(strCurName);
        if(nIndex == -1){
            listName.append(strCurName);
        }else{
            listName.removeAt(nIndex);
        }
        int nCount = listName.size();
        for(int n=0; n<nCount; n++){
            strResult += listName.at(n);
            if(n == nCount-1){
                break;
            }
            strResult += "/";
        }
    }
    return strResult;
}


/********************************************************
 *@Name:        ResponseProjectButton
 *@Author:      HuaT
 *@Description: 响应指定按钮项目名称
 *@Param1:      按钮对象
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-5-22
********************************************************/
void TestInterface::ResponseProjectButton(QPushButton *butObj)
{
    QString strResult = "";
    QString strCurName = butObj->text();
    QString strNameRecord = ui->lb_Test_TestProject->text();

    strResult = TransformProjectName(strCurName,strNameRecord);

    //qDebug()<<ui->checkBox_Test_AllSelect->checkState();
    if(ui->checkBox_Test_AllSelect->isChecked() == true){
        for(int n=0; n< TABLE_ROWS_COUNT; n++){
            SetCellContent(TABLE_COLUMN_COUNT-1,n,strResult);
        }
    }else{
        //
        int nCurRow = ui->tw_Test_TestInfo->currentRow();
        if(nCurRow == -1){
            return;
        }
        SetCellContent(TABLE_COLUMN_COUNT-1,nCurRow,strResult);
    }
    ui->lb_Test_TestProject->setText(strResult);
}

/********************************************************
 *@Name:        SetRuntimeButtonEnable
 *@Author:      HuaT
 *@Description: 设置测试时详细界面的按钮状态
 *@Param1:      按钮状态是否可用
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-5-22
********************************************************/
void TestInterface::SetRuntimeButtonEnable(bool isTrue)
{
    ui->pb_Test_ScanModel->setEnabled(isTrue);
    ui->pb_Test_ClearTestName->setEnabled(isTrue);

    ui->pb_Test_TestName1->setEnabled(isTrue);
    ui->pb_Test_TestName2->setEnabled(isTrue);
    ui->pb_Test_TestName3->setEnabled(isTrue);
    ui->pb_Test_TestName4->setEnabled(isTrue);

    ui->le_Test_SampleNumber->setEnabled(isTrue);

    ui->checkBox_Test_Emergency->setEnabled(isTrue);

    ui->pb_Test_One->setEnabled(isTrue);
    ui->pb_Test_Two->setEnabled(isTrue);
    ui->pb_Test_Three->setEnabled(isTrue);
    ui->pb_Test_Four->setEnabled(isTrue);
    ui->pb_Test_Five->setEnabled(isTrue);
    ui->pb_Test_Six->setEnabled(isTrue);
    ui->pb_Test_Seven->setEnabled(isTrue);
    ui->pb_Test_Eight->setEnabled(isTrue);
    ui->pb_Test_Nine->setEnabled(isTrue);
    ui->pb_Test_Zero->setEnabled(isTrue);
    ui->pb_Test_Clear->setEnabled(isTrue);
    ui->pb_Test_OK->setEnabled(isTrue);
}

/********************************************************
 *@Name:        SetTestStatus
 *@Author:      HuaT
 *@Description: 设置测试中各个按钮状态
 *@Param1:      所有按钮的状态是否可用
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-5-22
********************************************************/
void TestInterface::SetTestStatus(bool isTrue)
{
    /*bool isStartTest = false;
    if(isTrue){
        isStartTest = false;
    }else{
        isStartTest = true;
    }*/

}

/********************************************************
 *@Name:        SetRowColor
 *@Author:      HuaT
 *@Description: 设置行颜色
 *@Param1:      行颜色对象
 *@Param2:      行号
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-5-22
********************************************************/
void TestInterface::SetRowColor(QColor color,quint8 nRow)
{
    ui->tw_Test_TestInfo->item(nRow,0)->setBackgroundColor(color);
    ui->tw_Test_TestInfo->item(nRow,1)->setBackgroundColor(color);
    ui->tw_Test_TestInfo->item(nRow,2)->setBackgroundColor(color);
}

/********************************************************
 *@Name:        GetCheckSum
 *@Author:      HuaT
 *@Description: 获取数据的校验和
 *@Param1:      数据长度
 *@Param2:      数据内容
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-5-22
********************************************************/
quint32 TestInterface::GetCheckSum(QByteArray byarrDataLength, QByteArray byarrData)
{
    //qDebug()<<byarrDataLength.toHex().toUpper();
    //qDebug()<<byarrData.toHex().toUpper();
    quint32 nCount = 0;
    for(int n=0; n<byarrDataLength.size(); n++){
        nCount += (quint8)byarrDataLength.at(n);
    }
    for(int n=0; n<byarrData.size(); n++){
        nCount += (quint8)byarrData.at(n);
    }
    //qDebug()<<nCount << ~nCount << ~nCount + 1;
    return ~nCount + 1;
}

/********************************************************
 *@Name:        IntToBytes
 *@Author:      HuaT
 *@Description: 整形转字节型
 *@Param1:      数据
 *@Return:      数据的字节形式
 *@Version:     1.0
 *@Date:        2018-5-22
********************************************************/
QByteArray TestInterface::IntToBytes(quint32 nValue, quint8 nCount)
{
    QByteArray byarrCheckSum;
    //高位在前,低位在后
    /*for(int n=nCount-1; n != -1; n--){
        byarrCheckSum.append( (quint8)( (nValue>> (n*8) ) & 0xFF) );
    }*/
    //低位在前,高位在后
    for(int n=0; n < nCount; n++){
        byarrCheckSum.append( (quint8)( (nValue>> (n*8) ) & 0xFF) );
    }
    return byarrCheckSum;
}

/********************************************************
 *@Name:        BytesToInt
 *@Author:      HuaT
 *@Description: 字节型转整型
 *@Param1:      数组数据，字节由低到高
 *@Return:      整型
 *@Version:     1.0
 *@Date:        2018-5-22
********************************************************/
quint32 TestInterface::BytesToInt(QByteArray byarr)
{
    quint32 result = 0;
    if(byarr.size() == 4){
        int a = (byarr[3] & 0xff) << 24;
        int b = (byarr[2] & 0xff) << 16;
        int c = (byarr[1] & 0xff) << 8;
        int d = (byarr[0] & 0xff);
        result = a | b | c | d;
    }else if(byarr.size() == 2){
        int a = (byarr[1] & 0xff) << 8;
        int b = (byarr[0] & 0xff);
        result = a | b;
    }
    return result;
}


/********************************************************
 *@Name:        InitVectorTestInfo
 *@Author:      HuaT
 *@Description: 初始化测试数据
 *@Param1:      无
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-5-22
********************************************************/
void TestInterface::InitVectorTestInfo()
{
    for(int n=0; n<TABLE_ROWS_COUNT; n++){
        TestInfo ti;
        ti.m_si.m_SamPos.m_nSamplePos = n;
        ti.m_timer = new QTimer;
        connect(ti.m_timer,SIGNAL(timeout()),this,SLOT(CountDown()));
        m_vecTestInfo.append(ti);
        //ti.m_timer->setProperty()
    }
}

/********************************************************
 *@Name:        SendSerialData
 *@Author:      HuaT
 *@Description: 发送串口数据
 *@Param1:      串口对象
 *@Param2:      功能号
 *@Param3:      数据内容
 *@Return:      数据结构体
 *@Version:     1.0
 *@Date:        2018-6-16
********************************************************/
void TestInterface::SendSerialData(QextSerialPort& ser, quint16 nFuncIndex,QByteArray arrData)
{
    QByteArray byarrMsg;
    MsgData msgd;
    qDebug()<<"nFuncIndex:"<<nFuncIndex;
    msgd.m_FuncIndex = nFuncIndex;
    msgd.m_DataLength = arrData.size()/4;
    //qDebug()<<"arrData.size()"<<arrData.size();
    msgd.m_Data = arrData;
    byarrMsg.append(IntToBytes(msgd.m_frameHeader));
    byarrMsg.append(IntToBytes(msgd.m_ProductID));
    //qDebug()<<msgd.m_ProductID;
    byarrMsg.append(IntToBytes(msgd.m_DeviceAdd,2));
    byarrMsg.append(IntToBytes(msgd.m_FuncIndex,2));
    byarrMsg.append(IntToBytes(msgd.m_DataLength));

    byarrMsg.append(msgd.m_Data);
    byarrMsg.append(IntToBytes(GetCheckSum(IntToBytes(msgd.m_DataLength),msgd.m_Data)));
    //qDebug()<<GetCheckSum(IntToBytes(msgd.m_DataLength),msgd.m_Data);
    byarrMsg.append(IntToBytes(msgd.m_frameEnd));
    ser.write(byarrMsg);
    qDebug()<<byarrMsg.toHex().toUpper();
}

/*
 *详细页测试项目1按钮响应事件
 */
void TestInterface::on_pb_Test_TestName1_clicked()
{
    ResponseProjectButton(ui->pb_Test_TestName1);
}

/*
 *详细页测试项目2按钮响应事件
 */
void TestInterface::on_pb_Test_TestName2_clicked()
{
    ResponseProjectButton(ui->pb_Test_TestName2);
}

/*
 *详细页测试项目3按钮响应事件
 */
void TestInterface::on_pb_Test_TestName3_clicked()
{
    ResponseProjectButton(ui->pb_Test_TestName3);
}

/*
 *详细页测试项目4按钮响应事件
 */
void TestInterface::on_pb_Test_TestName4_clicked()
{
    ResponseProjectButton(ui->pb_Test_TestName4);
}

/*
 *详细页数字1响应事件
 */
void TestInterface::on_pb_Test_One_clicked()
{
    QString strCur = ui->le_Test_SampleNumber->text();
    ui->le_Test_SampleNumber->setText(strCur+"1");
}

/*
 *详细页数字2响应事件
 */
void TestInterface::on_pb_Test_Two_clicked()
{
    QString strCur = ui->le_Test_SampleNumber->text();
    ui->le_Test_SampleNumber->setText(strCur+"2");
}

/*
 *详细页数字3响应事件
 */
void TestInterface::on_pb_Test_Three_clicked()
{
    QString strCur = ui->le_Test_SampleNumber->text();
    ui->le_Test_SampleNumber->setText(strCur+"3");
}

/*
 *详细页数字4响应事件
 */
void TestInterface::on_pb_Test_Four_clicked()
{
    QString strCur = ui->le_Test_SampleNumber->text();
    ui->le_Test_SampleNumber->setText(strCur+"4");
}

/*
 *详细页数字5响应事件
 */
void TestInterface::on_pb_Test_Five_clicked()
{
    QString strCur = ui->le_Test_SampleNumber->text();
    ui->le_Test_SampleNumber->setText(strCur+"5");
}

/*
 *详细页数字6响应事件
 */
void TestInterface::on_pb_Test_Six_clicked()
{
    QString strCur = ui->le_Test_SampleNumber->text();
    ui->le_Test_SampleNumber->setText(strCur+"6");
}

/*
 *详细页数字7响应事件
 */
void TestInterface::on_pb_Test_Seven_clicked()
{
    QString strCur = ui->le_Test_SampleNumber->text();
    ui->le_Test_SampleNumber->setText(strCur+"7");
}

/*
 *详细页数字8响应事件
 */
void TestInterface::on_pb_Test_Eight_clicked()
{
    QString strCur = ui->le_Test_SampleNumber->text();
    ui->le_Test_SampleNumber->setText(strCur+"8");
}

/*
 *详细页数字9响应事件
 */
void TestInterface::on_pb_Test_Nine_clicked()
{
    QString strCur = ui->le_Test_SampleNumber->text();
    ui->le_Test_SampleNumber->setText(strCur+"9");
}

/*
 *详细页清除按钮响应事件
 */
void TestInterface::on_pb_Test_Clear_clicked()
{
    ui->le_Test_SampleNumber->setText("");
}

/*
 *详细页数字0响应事件
 */
void TestInterface::on_pb_Test_Zero_clicked()
{
    QString strCur = ui->le_Test_SampleNumber->text();
    ui->le_Test_SampleNumber->setText(strCur+"0");
}

/*
 *详细页确定按钮响应事件
 */
void TestInterface::on_pb_Test_OK_clicked()
{
    QString strCur = ui->le_Test_SampleNumber->text();
    if(strCur.isEmpty() || strCur.trimmed().isEmpty()){
        return;
    }
    int nCurRow = ui->tw_Test_TestInfo->currentRow();
    if(nCurRow == -1){
        QMessageBox::information(this,QObject::tr("提示"),QObject::tr("请先选中行!"),QMessageBox::Ok);
    }else{
        SetCellContent(TABLE_COLUMN_COUNT-2,nCurRow,strCur);
    }
}

/*
 *详细页列表点击响应事件
 */
void TestInterface::on_tw_Test_TestInfo_cellClicked(int row, int column)
{
    QTableWidgetItem* itemPos = ui->tw_Test_TestInfo->item(row,TABLE_COLUMN_COUNT-3);
    QTableWidgetItem* itemNum = ui->tw_Test_TestInfo->item(row,TABLE_COLUMN_COUNT-2);
    QTableWidgetItem* itemName = ui->tw_Test_TestInfo->item(row,TABLE_COLUMN_COUNT-1);
    ui->lb_Test_TestProject->setText(itemName->text());
    ui->le_Test_SampleNumber->setText(itemNum->text());
    ui->lb_Test_CurrentSamPos->setText(itemPos->text());

    //急诊位置
    int nEmerPos = ui->lb_Test_CurrentEmerPos->text().toInt();
    if(nEmerPos == row+1){
        ui->checkBox_Test_Emergency->setChecked(true);
    }else{
        ui->checkBox_Test_Emergency->setChecked(false);
    }
}


/*
 *急诊选项状态改变事件
 */
//void TestInterface::on_checkBox_Test_Emergency_stateChanged(int arg1)
//{
//    int nRow = ui->tw_Test_TestInfo->currentRow();
//    qDebug()<<"nrow:"<<nRow;
//    if(nRow < 0){
//        //ui->checkBox_Test_Emergency->setChecked(false);
//        //QMessageBox::information(this,QObject::tr("提示"),QObject::tr("请先选择急诊对象"),QMessageBox::Ok);

//        return;
//    }

//}

/*
 *急诊选项点击响应事件
 */
void TestInterface::on_checkBox_Test_Emergency_clicked(bool checked)
{
    int nRow = ui->tw_Test_TestInfo->currentRow();
    if(nRow < 0){
        QMessageBox::information(this,QObject::tr("提示"),QObject::tr("请先选择急诊对象"),QMessageBox::Ok);
        return;
    }
    //急诊
    if(ui->checkBox_Test_Emergency->isChecked()){
        for(int n=0; n<TABLE_ROWS_COUNT; n++){
            SetRowColor(QColor(255,255,255),n);
        }
        SetRowColor(QColor(0,255,0),nRow);
        //显示当前的急诊行
        ui->lb_Test_CurrentEmerPos->setText(QString("%1").arg(nRow+1));
    }//取消急诊
    else{
        SetRowColor(QColor(255,255,255),nRow);
        //当前无急诊
        ui->lb_Test_CurrentEmerPos->setText(QObject::tr("无"));
    }

}


//解析条码数据
/********************************************************
 *@Name:        ParseScanBarCodeInfo
 *@Author:      HuaT
 *@Description: 解析条码数据
 *@Param1:      条码数据数组,数据格式为：16字节char，加4字节状态
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-6-16
********************************************************/
void TestInterface::ParseScanBarCodeInfo(const QByteArray &ScanData)
{
    if(ScanData.size() != 320){
        return;
    }
    ScanBarCodeInfo barcode;
    memcpy(&barcode, ScanData, ScanData.size());
    //qDebug()<<sizeof(ScanBarCodeInfo);
    QString strBarCode;
    for(int n=0; n<SAMPLECOUNT; n++){
        strBarCode.clear();
        //qDebug()<<barcode.scaninfo[n].Scan_State;
        if(barcode.scaninfo[n].Scan_State == 2){
            //strBarCode.clear();
            for(int i=0; i<BARCODELENGTH; i++){
                strBarCode += barcode.scaninfo[n].CODE[i];
            }
        }
        //qDebug()<<strBarCode;
        m_vecTestInfo[n].m_si.m_strSampleNo = strBarCode.trimmed();
    }
}


/********************************************************
 *@Name:        ShowBarCodeInfo
 *@Author:      HuaT
 *@Description: 显示条码信息
 *@Param1:      条码信息数组
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-6-16
********************************************************/
void TestInterface::ShowBarCodeInfo(QVector<TestInfo> vecTestInfo)
{
    for(int n=0; n<vecTestInfo.size(); n++){
        ui->tw_Test_TestInfo->item(n,0)->setText(QString::number(vecTestInfo[n].m_si.m_SamPos.m_nSamplePos));
        ui->tw_Test_TestInfo->item(n,1)->setText(vecTestInfo[n].m_si.m_strSampleNo);
        ui->tw_Test_TestInfo->item(n,2)->setText(vecTestInfo[n].m_strItemName);
        //qDebug()<<"1:"<<(vecTestInfo[n].m_nSamplePos)<<" 2:"<<vecTestInfo[n].m_strSampleNo<<" 3:"<<vecTestInfo[n].m_strItemName;
    }
}


/********************************************************
 *@Name:        ParseLoadSampleInfo
 *@Author:      HuaT
 *@Description: 解析加样信息
 *@Param1:      加样信息数组
 *@Param2:      待填充结构体
 *@Return:      返回数据解析是否正确
 *@Version:     1.0
 *@Date:        2018-6-16
********************************************************/
bool TestInterface::ParseLoadSampleInfo(const QByteArray &SampleData, SampleInfo& si)
{
    if(SampleData.size() != 16){
        qDebug()<<"ParseLoadSampleInfo:Short Current Length is "<<SampleData.size();
        return false;
    }
    si.m_SamPos.m_nSamplePos = BytesToInt(SampleData.mid(0,4));
    si.m_SamPos.m_nReagentPos = BytesToInt(SampleData.mid(4,4));

    quint8 IDCardPos = BytesToInt(SampleData.mid(8,4));
    //ID卡剩余总数
    quint8 IDCardCount = BytesToInt(SampleData.mid(12,4));
    //更新当前剩余数量，
    if(!UpdateIDCardAmount(IDCardPos,IDCardCount)){
        return false;
    }

    //记录样本位对应的试剂位
    if(si.m_SamPos.m_nReagentPos == 0){
        m_vecTestInfo[si.m_SamPos.m_nSamplePos].m_si.m_SamPos.m_nReagentPos = -1;
    }else{
        m_vecTestInfo[si.m_SamPos.m_nSamplePos].m_si.m_SamPos.m_nReagentPos = si.m_SamPos.m_nReagentPos;
    }

    return true;
}

/********************************************************
 *@Name:        UpdateIDCardAmount
 *@Author:      HuaT
 *@Description: 更新当前ID卡数量,并保存至文件
 *@Param1:      对应卡槽位置1-4
 *@Param2:      卡槽位置剩余卡数量
 *@Return:      更新是否成功
 *@Version:     1.0
 *@Date:        2018-6-16
********************************************************/
bool TestInterface::UpdateIDCardAmount(quint8 nIDCardPos, quint8 nIDCardAmount)
{
    switch(nIDCardPos){
    case 1:
        ui->proBar_Test_Reagent1->setValue(nIDCardAmount);
        m_settins->SetParam(REAGENTAMOUNT1,QString::number(nIDCardAmount));
        break;
    case 2:
        ui->proBar_Test_Reagent2->setValue(nIDCardAmount);
        m_settins->SetParam(REAGENTAMOUNT2,QString::number(nIDCardAmount));
        break;
    case 3:
        ui->proBar_Test_Reagent3->setValue(nIDCardAmount);
        m_settins->SetParam(REAGENTAMOUNT3,QString::number(nIDCardAmount));
        break;
    case 4:
        ui->proBar_Test_Reagent4->setValue(nIDCardAmount);
        m_settins->SetParam(REAGENTAMOUNT4,QString::number(nIDCardAmount));
        break;
    default:
        qDebug()<<"UpdateIDCardAmount:IDCardPos is error type-"<<nIDCardPos;
        return false;
    }
    //写入配置文件
    m_settins->WriteSettingsInfoToMap();
    return true;
}

/********************************************************
 *@Name:        ProceStartLoadSample
 *@Author:      HuaT
 *@Description: 处理加样完成信息，开始计时，并发送下一个测试给仪器
 *@Param1:      加样信息数组
 *@Param2:      待填充结构体
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-6-16
********************************************************/
void TestInterface::ProceStartLoadSample(const QByteArray &SampleData)
{
    SampleInfo si;
    //解析仪器发来数据
    if(!ParseLoadSampleInfo(SampleData,si)){
        QMessageBox::information(this,QObject::tr("Note"),QObject::tr("解析加样信息错误"),QMessageBox::Ok);
        return;
    }
    //发送下一个测试给仪器
    QByteArray byarrTestInfo = PacketTestInfoToByarr(m_vecTestInfo);
    if(!byarrTestInfo.isEmpty()){
        SendSerialData(m_ControlPanelsSerial,PL_FUN_AM_START_SAMPLE,byarrTestInfo);
    }
    if(si.m_SamPos.m_nReagentPos != 0){
        //试剂盘颜色改变
        m_SampleCircle->SetItemColor(si.m_SamPos.m_nReagentPos,QString("rgb(255,0,0)"));
        //对应试剂位置开始计时
        m_vecTestInfo[si.m_SamPos.m_nSamplePos].m_nRemainTime = 10;
        m_vecTestInfo.at(si.m_SamPos.m_nSamplePos).m_timer->setProperty("ReagentPos",si.m_SamPos.m_nReagentPos);
        m_vecTestInfo.at(si.m_SamPos.m_nSamplePos).m_timer->setProperty("SamplePos",si.m_SamPos.m_nSamplePos);
        m_vecTestInfo.at(si.m_SamPos.m_nSamplePos).m_timer->start(1000);
    }else{
        //
        m_nCompleteTestCount++;
        UpdateTestInfoBaseParam(m_nCompleteTestCount);
        //检测是否有项目在进行，如果没有，所有测试完成
        QVector<TestInfo>::iterator iter;
        for(iter = m_vecTestInfo.begin(); iter != m_vecTestInfo.end(); iter++){
            if( ( ((TestInfo*)(iter))->m_timer->isActive() ) || !byarrTestInfo.isEmpty() ){
                //如果有就返回
                return;
            }
        }
        //没有，测试完成
        AllTestComplete();
    }

}

/********************************************************
 *@Name:        PorceLoadSampleComplete
 *@Author:      HuaT
 *@Description: 处理加样完成返回数据
 *@Param1:      ACK数据
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-6-16
********************************************************/
void TestInterface::PorceLoadSampleComplete(const QByteArray &AckData)
{
    //解析返回数据
    SamplePos sp;
    memcpy(&sp, AckData,AckData.size());
    //qDebug()<<"samplepos:"<<sp.m_nSamplePos<<sp.m_nReagentPos;
    //发送开始测试信号
    QByteArray byarrData;
    byarrData.append(IntToBytes(sp.m_nSamplePos));
    byarrData.append(IntToBytes(sp.m_nReagentPos));
    SendSerialData(m_CheckPanelsSerial,PL_FUN_AM_START_TEST,byarrData);
}

/********************************************************
 *@Name:        ParseCheckPanelsAck
 *@Author:      HuaT
 *@Description: 解析检测板返回的ACK
 *@Param1:      ACK数据
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-6-26
********************************************************/
void TestInterface::ParseCheckPanelsAck(const QByteArray &AckData)
{
    if(AckData.size() != 16){
        qDebug()<<"ParseCheckPanelsAck - The length is not enough:"<<AckData.size();
        return ;
    }
    quint32 nFunIndex  = BytesToInt(AckData.mid(0,4));
    quint32 nErrType   = BytesToInt(AckData.mid(4,4));
    quint32 nStatusDef = BytesToInt(AckData.mid(8,4));
    switch(nFunIndex){
    case PL_FUN_AM_HARDWEAR_CHECK:
        if(nErrType == 0){

        }else if(nErrType == 1){
            qDebug()<<"命令："<<nFunIndex<<";数据错误";
        }else if(nErrType == 2){
            qDebug()<<"命令："<<nFunIndex<<";检验和错误";
        }
        //状态定义
        if(nStatusDef == 0){
            //启动定时器，发送命令给控制板，盘可以转动
            m_TimerTestCheck.stop();
            connect(&m_TimerControlCheck,SIGNAL(timeout()), this, SLOT(ControlCheckFunc()) );
            m_TimerControlCheck.start(1000);
        }
        break;
    case PL_FUN_AM_NEW_TEST:
        //新建测试
        break;
    case PL_FUN_AM_START_SAMPLE:
        //开始加样
        break;
    case PL_FUN_AM_PREPARE_TEST:
        //准备测试
        break;
    case PL_FUN_AM_START_TEST :
        //开始测试
        break;
    case PL_FUN_AM_PREPARE_UNSTALL:
        //准备卸卡
        break;
    case PL_FUN_AM_START_UNSTALL:
        //开始卸卡
        break;
    default:
        break;
    }
}

/********************************************************
 *@Name:        ParseControlPanelsAck
 *@Author:      HuaT
 *@Description: 解析控制板返回的ACK
 *@Param1:      ACK数据
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-6-26
********************************************************/
void TestInterface::ParseControlPanelsAck(const QByteArray& AckData)
{
    if(AckData.size() != 16){
        qDebug()<<"ParseControlPanelsAck - The length is not enough:"<<AckData.size();
        return ;
    }
    quint32 nFunIndex  = BytesToInt(AckData.mid(0,4));
    quint32 nErrType   = BytesToInt(AckData.mid(4,4));
    quint32 nStatusDef = BytesToInt(AckData.mid(8,4));

    //qDebug()<<"m_byarrUnstallCard:"<<m_byarrUnstallCard;
    switch(nFunIndex){
    case PL_FUN_AM_HARDWEAR_CHECK:
        if(nErrType == 0){

        }else if(nErrType == 1){
            qDebug()<<"命令："<<nFunIndex<<";数据错误";
        }else if(nErrType == 2){
            qDebug()<<"命令："<<nFunIndex<<";检验和错误";
        }
        //状态定义
        if(nStatusDef == 0){
            //停止控制查询命令
            m_TimerControlCheck.stop();
            //自检状态
            m_bIsCheckStatus = true;
            //解析卸卡数据
            QString strUnstalValue = QString("%1").arg( BytesToInt(AckData.mid(12,4)) ,32,2,QLatin1Char('0'));
            if(m_byarrUnstallCard.isEmpty()){
                m_byarrUnstallCard = strUnstalValue.toAscii();
            }
            ParseUnstallCardData();
        }else if(nStatusDef == 1){

        }
        break;
    case PL_FUN_AM_NEW_TEST:
        //新建测试
        break;
    case PL_FUN_AM_START_SAMPLE:
        //开始加样
        break;
    case PL_FUN_AM_PREPARE_TEST:
        //准备测试
        break;
    case PL_FUN_AM_START_TEST :
        //开始测试
        break;
    case PL_FUN_AM_PREPARE_UNSTALL:
        //准备卸卡
        break;
    case PL_FUN_AM_START_UNSTALL:
        //开始卸卡
        break;
    default:
        break;
    }
}

/********************************************************
 *@Name:        ParseUnstallCardData
 *@Author:      HuaT
 *@Description: 解析卸卡队列数据
 *@Param1:      无
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-6-16
********************************************************/
void TestInterface::ParseUnstallCardData()
{
    //qDebug()<<"m_byarrUnstallCard:"<<m_byarrUnstallCard;
    for(int n=31,i=1; n!=11; n--,i++){
        if((quint8)m_byarrUnstallCard[n] == 49){
            m_SampleCircle->SetItemText(i,"退卡中");
            m_SampleCircle->SetItemColor(i,"rgb(0,255,0)");
        }
    }
    for(int n=31,i=1; n!=11&&i<21; n--,i++){
        if( (quint8)m_byarrUnstallCard[n] == 49 ){
            //开始卸卡
            QByteArray byarrUnstallNum;
            byarrUnstallNum = IntToBytes(i);
            SendSerialData(m_ControlPanelsSerial,PL_FUN_AM_PREPARE_UNSTALL,byarrUnstallNum);
            m_byarrUnstallCard[n] = 48;
            //qDebug()<<n<<m_byarrUnstallCard;
            return;
        }
    }
    //所有卡卸载完后，自检完成
    m_bIsCheckStatus = false;
    //
    m_byarrUnstallCard.clear();
    //改变样品圆颜色
    DefaultSampleCircleUI();
    //关闭自检提示
    ((MainWindow*)m_pMainWnd)->SetCheckStatusHide(true);
    //新建测试可用
    ui->pb_Test_NewTest->setEnabled(true);
    ui->pb_Test_DetailsInfo->setEnabled(true);

}


/********************************************************
 *@Name:        ProceCountDownEvent
 *@Author:      HuaT
 *@Description: 试剂计时器处理函数
 *@Param1:      本次倒计时的时间
 *@Param2:      试剂的位置
 *@Param3:      样本的位置
 *@Return:      无
 *@Version:     1.0
 *@Date:        2018-6-16
********************************************************/
void TestInterface::ProceCountDownEvent(quint8 nReagentIndex,quint8 nSamplePos)
{
    //如果没有获得倒计时时间
    /*if(m_vecTestInfo[nSamplePos].m_bIsTime == false){
        m_vecTestInfo[nSamplePos].m_nRemainTime = nTime;
        m_vecTestInfo[nSamplePos].m_bIsTime = true;
    }*/
    //如果时间到了
    if(m_vecTestInfo[nSamplePos].m_nRemainTime == 0){
        //停止计时
        m_vecTestInfo[nSamplePos].m_timer->stop();
        //改变试剂圆显示状态
        m_SampleCircle->SetItemColor(nReagentIndex,"rgb(0,0,255)");
        m_SampleCircle->SetItemText(nReagentIndex,"检测中");
        //发送命令开始-准备测试
        QByteArray byarrData = IntToBytes(nSamplePos);
        byarrData.append(IntToBytes(nReagentIndex));
        //准备测试
        SendSerialData(m_ControlPanelsSerial,PL_FUN_AM_PREPARE_TEST,byarrData);
        return;
    }
    //显示剩余时间
    m_vecTestInfo[nSamplePos].m_nRemainTime--;
    m_SampleCircle->SetItemText(nReagentIndex,QString("%1s").arg(m_vecTestInfo[nSamplePos].m_nRemainTime));
}





